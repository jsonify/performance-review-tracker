{% extends "base.html" %}

{% block title %}Performance Review Tracker - Dashboard{% endblock %}

{% block content %}
<div class="main-header">
    <h1><i class="fas fa-chart-line"></i> Performance Review Tracker</h1>
    <p>Generate professional performance reviews with AI-powered analysis</p>
</div>

<!-- Step 1: Review Criteria Configuration -->
<div class="section-card" data-step="1">
    <div class="section-header">
        <div class="section-number">1</div>
        <h3>Review Criteria Configuration</h3>
    </div>
    
    <!-- Annual Review Criteria Section -->
    <div class="criteria-section mb-4">
        <h5 class="mb-3"><i class="fas fa-calendar-alt"></i> Annual Review Criteria</h5>
        
        <!-- Annual Review Toggle -->
        <div class="mb-3">
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="annual-input-method" id="annual-upload-method" value="upload" checked>
                <label class="btn btn-outline-primary" for="annual-upload-method">
                    <i class="fas fa-upload"></i> Upload JSON File
                </label>
                
                <input type="radio" class="btn-check" name="annual-input-method" id="annual-manual-method" value="manual">
                <label class="btn btn-outline-primary" for="annual-manual-method">
                    <i class="fas fa-edit"></i> Enter Manually
                </label>
            </div>
        </div>
        
        <!-- Annual Review Upload Section -->
        <div id="annual-upload-section" class="criteria-input-section">
            <div class="upload-area" id="annual-upload-area">
                <input type="file" id="annual-criteria-file" accept=".json" style="display: none;">
                <i class="fas fa-upload fa-2x mb-2"></i>
                <p class="mb-0">Click or drag to upload annual review criteria</p>
                <small class="text-muted">JSON format required</small>
            </div>
            <div id="annual-criteria-status" class="mt-2"></div>
        </div>
        
        <!-- Annual Review Manual Entry Section -->
        <div id="annual-manual-section" class="criteria-input-section" style="display: none;">
            <!-- Form for adding new criteria -->
            <div class="criteria-form mb-4">
                <h6 class="mb-3"><i class="fas fa-plus-circle"></i> Add Annual Review Criteria</h6>
                <div class="row">
                    <div class="col-md-4">
                        <label for="annual-section-name" class="form-label">Section Name</label>
                        <input type="text" id="annual-section-name" class="form-control" 
                               placeholder="e.g., Leadership, Innovation">
                    </div>
                    <div class="col-md-5">
                        <label for="annual-section-description" class="form-label">Description</label>
                        <input type="text" id="annual-section-description" class="form-control" 
                               placeholder="e.g., Demonstrates leadership capabilities">
                    </div>
                    <div class="col-md-2">
                        <label for="annual-section-weight" class="form-label">Weight (%)</label>
                        <input type="number" id="annual-section-weight" class="form-control" 
                               placeholder="20" min="1" max="100">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" id="add-annual-criteria-btn" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Display entered criteria -->
            <div class="entered-criteria mb-4">
                <h6 class="mb-3"><i class="fas fa-list"></i> Entered Criteria</h6>
                <div id="annual-criteria-display" class="criteria-display">
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-info-circle"></i> No criteria entered yet. Add some above to get started.
                    </div>
                </div>
            </div>
            
            <!-- Save button -->
            <div class="text-end mb-3">
                <button type="button" id="save-annual-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save All Criteria
                </button>
            </div>
            
            <div id="annual-manual-status" class="mt-2"></div>
        </div>
    </div>
    
    <!-- Competency Criteria Section -->
    <div class="criteria-section">
        <h5 class="mb-3"><i class="fas fa-cogs"></i> Competency Criteria</h5>
        
        <!-- Competency Toggle -->
        <div class="mb-3">
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="competency-input-method" id="competency-upload-method" value="upload" checked>
                <label class="btn btn-outline-primary" for="competency-upload-method">
                    <i class="fas fa-upload"></i> Upload JSON File
                </label>
                
                <input type="radio" class="btn-check" name="competency-input-method" id="competency-manual-method" value="manual">
                <label class="btn btn-outline-primary" for="competency-manual-method">
                    <i class="fas fa-edit"></i> Enter Manually
                </label>
            </div>
        </div>
        
        <!-- Competency Upload Section -->
        <div id="competency-upload-section" class="criteria-input-section">
            <div class="upload-area" id="competency-upload-area">
                <input type="file" id="competency-criteria-file" accept=".json" style="display: none;">
                <i class="fas fa-upload fa-2x mb-2"></i>
                <p class="mb-0">Click or drag to upload competency criteria</p>
                <small class="text-muted">JSON format required</small>
            </div>
            <div id="competency-criteria-status" class="mt-2"></div>
        </div>
        
        <!-- Competency Manual Entry Section -->
        <div id="competency-manual-section" class="criteria-input-section" style="display: none;">
            <!-- Form for adding new competency -->
            <div class="criteria-form mb-4">
                <h6 class="mb-3"><i class="fas fa-plus-circle"></i> Add Competency Area</h6>
                
                <!-- Competency Name and Description -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="competency-name" class="form-label">Competency Name</label>
                        <input type="text" id="competency-name" class="form-control" 
                               placeholder="e.g., Programming, Problem Management">
                    </div>
                    <div class="col-md-8">
                        <label for="competency-description" class="form-label">Description</label>
                        <input type="text" id="competency-description" class="form-control" 
                               placeholder="e.g., Software development and coding skills">
                    </div>
                </div>
                
                <!-- Level Definitions -->
                <div class="level-definitions mb-3">
                    <label class="form-label">Level Definitions (1-5 scale)</label>
                    <div class="row g-2">
                        <div class="col-md-2">
                            <label class="form-label small">Level 1 (Learning)</label>
                            <input type="text" id="competency-level-1" class="form-control form-control-sm" 
                                   placeholder="Beginning to apply">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Level 2 (Developing)</label>
                            <input type="text" id="competency-level-2" class="form-control form-control-sm" 
                                   placeholder="Building proficiency">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Level 3 (Practicing)</label>
                            <input type="text" id="competency-level-3" class="form-control form-control-sm" 
                                   placeholder="Consistent competency">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Level 4 (Mastering)</label>
                            <input type="text" id="competency-level-4" class="form-control form-control-sm" 
                                   placeholder="Advanced proficiency">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Level 5 (Leading)</label>
                            <input type="text" id="competency-level-5" class="form-control form-control-sm" 
                                   placeholder="Expert level">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">&nbsp;</label>
                            <button type="button" id="add-competency-btn" class="btn btn-success w-100 btn-sm">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Display entered competencies -->
            <div class="entered-criteria mb-4">
                <h6 class="mb-3"><i class="fas fa-list"></i> Entered Competencies</h6>
                <div id="competency-criteria-display" class="criteria-display">
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-info-circle"></i> No competencies entered yet. Add some above to get started.
                    </div>
                </div>
            </div>
            
            <!-- Save button -->
            <div class="text-end mb-3">
                <button type="button" id="save-competency-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save All Competencies
                </button>
            </div>
            
            <div id="competency-manual-status" class="mt-2"></div>
        </div>
    </div>
</div>

<!-- Step 2: Review Configuration -->
<div class="section-card" data-step="2">
    <div class="section-header">
        <div class="section-number">2</div>
        <h3>Review Configuration</h3>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <label for="review-type" class="form-label">Review Type</label>
            <select id="review-type" class="form-select">
                <option value="competency" selected>Competency Assessment</option>
                <option value="annual">Annual Review</option>
            </select>
        </div>
        
        <div class="col-md-6">
            <label for="review-year" class="form-label">Review Year</label>
            <select id="review-year" class="form-select">
                {% for year in year_options %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- Step 3: Data Source -->
<div class="section-card" data-step="3">
    <div class="section-header">
        <div class="section-number">3</div>
        <h3>Data Source</h3>
    </div>
    
    <!-- Data Source Selection -->
    <div class="mb-3">
        <label class="form-label">Choose Data Source</label>
        <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="data-source" id="csv-source" value="csv" checked>
            <label class="btn btn-outline-primary" for="csv-source">
                <i class="fas fa-file-csv"></i> CSV Upload
            </label>
            
            <input type="radio" class="btn-check" name="data-source" id="ado-source" value="ado">
            <label class="btn btn-outline-primary" for="ado-source">
                <i class="fas fa-cloud"></i> Azure DevOps
            </label>
        </div>
    </div>
    
    <!-- CSV Upload Section -->
    <div id="csv-section" class="data-source-section">
        <label class="form-label">Accomplishments CSV File</label>
        <div class="upload-area" id="csv-upload-area">
            <input type="file" id="accomplishments-csv-file" accept=".csv" style="display: none;">
            <i class="fas fa-file-csv fa-2x mb-2"></i>
            <p class="mb-0">Click or drag to upload accomplishments CSV</p>
            <small class="text-muted">Requires Date and Title columns minimum</small>
        </div>
        <div id="csv-status" class="mt-2"></div>
    </div>
    
    <!-- Azure DevOps Section -->
    <div id="ado-section" class="data-source-section" style="display: none;">
        <div class="row">
            <div class="col-md-4">
                <label for="ado-org" class="form-label">Organization</label>
                <input type="text" id="ado-org" class="form-control" placeholder="your-org">
            </div>
            <div class="col-md-4">
                <label for="ado-project" class="form-label">Project</label>
                <input type="text" id="ado-project" class="form-control" placeholder="your-project">
            </div>
            <div class="col-md-4">
                <label for="ado-token" class="form-label">Personal Access Token</label>
                <div class="api-key-input">
                    <input type="password" id="ado-token" class="form-control" placeholder="Enter PAT">
                    <button type="button" class="api-key-toggle" onclick="togglePasswordVisibility('ado-token')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <label for="work-item-type" class="form-label">Work Item Type</label>
                <select id="work-item-type" class="form-select">
                    <option value="User Story" selected>User Story</option>
                    <option value="Task">Task</option>
                    <option value="Bug">Bug</option>
                    <option value="Feature">Feature</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="months-back" class="form-label">Months Back</label>
                <select id="months-back" class="form-select">
                    <option value="6">6 months</option>
                    <option value="12" selected>12 months</option>
                    <option value="18">18 months</option>
                    <option value="24">24 months</option>
                </select>
            </div>
        </div>
        
        <div class="mt-3">
            <button type="button" id="test-ado-btn" class="btn btn-outline-secondary me-2">
                <i class="fas fa-plug"></i> Test Connection
            </button>
            <button type="button" id="fetch-ado-btn" class="btn btn-primary">
                <i class="fas fa-download"></i> Fetch Data
            </button>
        </div>
        
        <div id="ado-status" class="mt-2"></div>
    </div>
</div>

<!-- Step 4: LLM Configuration -->
<div class="section-card" data-step="4">
    <div class="section-header">
        <div class="section-number">4</div>
        <h3>AI Analysis Configuration</h3>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <label for="llm-provider" class="form-label">LLM Provider</label>
            <select id="llm-provider" class="form-select">
                <option value="none">No AI Analysis (Automated Only)</option>
                {% for provider in llm_providers %}
                <option value="{{ provider.id }}" {% if provider.recommended %}selected{% endif %}>{{ provider.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-4">
            <label for="llm-model" class="form-label">Model</label>
            <div class="model-input-group">
                <input type="text" id="llm-model-input" class="form-control" placeholder="Enter model name or select from dropdown">
                <div class="model-controls">
                    <button type="button" id="clear-model-btn" class="btn btn-sm btn-outline-secondary" title="Clear model">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="dropdown">
                        <button type="button" id="model-dropdown-btn" class="btn btn-sm btn-outline-primary dropdown-toggle" aria-expanded="false" title="Select from models">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" id="model-dropdown-menu">
                            <li><h6 class="dropdown-header">Common Models</h6></li>
                            <!-- Common models populated by JavaScript -->
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Previously Used</h6></li>
                            <!-- Previously used models populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
            <select id="llm-model" class="form-select" style="display: none;">
                <option value="">Select model...</option>
            </select>
        </div>
        
        <div class="col-md-4">
            <label for="llm-api-key" class="form-label">API Key</label>
            <div class="api-key-input">
                <input type="password" id="llm-api-key" class="form-control" placeholder="Enter API key (optional)">
                <button type="button" class="api-key-toggle" onclick="togglePasswordVisibility('llm-api-key')">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="mt-2">
                <div id="stored-key-status" class="text-muted small"></div>
                <div class="btn-group-sm mt-1">
                    <button type="button" id="store-key-btn" class="btn btn-sm btn-outline-success" style="display: none;">
                        <i class="fas fa-save"></i> Store Key
                    </button>
                    <button type="button" id="delete-key-btn" class="btn btn-sm btn-outline-danger" style="display: none;">
                        <i class="fas fa-trash"></i> Delete Stored Key
                    </button>
                </div>
            </div>
            <small class="text-muted">Leave empty to use stored key or environment variables</small>
        </div>
    </div>
</div>

<!-- Step 5: Output Configuration -->
<div class="section-card" data-step="5">
    <div class="section-header">
        <div class="section-number">5</div>
        <h3>Output Format</h3>
    </div>
    
    <div class="btn-group w-100" role="group">
        <input type="radio" class="btn-check" name="output-format" id="markdown-format" value="markdown" checked>
        <label class="btn btn-outline-primary" for="markdown-format">
            <i class="fab fa-markdown"></i> Markdown
        </label>
        
        <input type="radio" class="btn-check" name="output-format" id="docx-format" value="docx">
        <label class="btn btn-outline-primary" for="docx-format">
            <i class="fas fa-file-word"></i> Word Document
        </label>
    </div>
</div>

<!-- Generate Button -->
<div class="text-center mt-4">
    <button type="button" id="generate-btn" class="btn btn-success btn-lg px-5">
        <i class="fas fa-magic"></i> Generate Performance Review
    </button>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Generating review...</span>
    </div>
    <p class="mt-2">Analyzing accomplishments and generating your performance review...</p>
</div>

<!-- Results Display -->
<div class="result-display">
    <div class="section-card">
        <div class="section-header">
            <div class="section-number"><i class="fas fa-check"></i></div>
            <h3>Analysis Complete</h3>
        </div>
        <div id="result-content"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // LLM Provider models mapping
    const modelsByProvider = {{ common_models | tojson }};
    
    // File upload handlers
    document.addEventListener('DOMContentLoaded', function() {
        setupFileUploads();
        setupDataSourceToggle();
        setupLLMProviderChange();
        setupGenerateButton();
    });
    
    function setupFileUploads() {
        // Annual criteria upload
        setupSingleFileUpload('annual-upload-area', 'annual-criteria-file', 'annual-criteria-status', '/api/upload-criteria', 'annual_criteria');
        
        // Competency criteria upload  
        setupSingleFileUpload('competency-upload-area', 'competency-criteria-file', 'competency-criteria-status', '/api/upload-criteria', 'competency_criteria');
        
        // CSV accomplishments upload
        setupSingleFileUpload('csv-upload-area', 'accomplishments-csv-file', 'csv-status', '/api/upload-accomplishments', 'accomplishments_csv');
        
        // Setup criteria input method toggles
        setupCriteriaInputToggles();
        
        // Setup manual criteria handlers
        setupManualCriteriaHandlers();
    }
    
    function setupSingleFileUpload(areaId, fileInputId, statusId, endpoint, fieldName) {
        const area = document.getElementById(areaId);
        const fileInput = document.getElementById(fileInputId);
        const status = document.getElementById(statusId);
        
        area.addEventListener('click', () => fileInput.click());
        
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });
        
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileUpload(fileInput, status, endpoint, fieldName);
            }
        });
        
        fileInput.addEventListener('change', () => {
            handleFileUpload(fileInput, status, endpoint, fieldName);
        });
    }
    
    function handleFileUpload(fileInput, statusDiv, endpoint, fieldName) {
        const file = fileInput.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append(fieldName, file);
        
        statusDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Uploading...</div>';
        
        fetch(endpoint, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || data[fieldName]?.success) {
                const result = data[fieldName] || data;
                statusDiv.innerHTML = `<div class="text-success"><i class="fas fa-check"></i> Uploaded successfully (${result.rows || result.sections || 0} items)</div>`;
                fileInput.parentElement.classList.add('success');
                
                // Store file path for later use
                if (fieldName === 'accomplishments_csv' && result.path) {
                    window.csvDataFile = result.path;
                }
            } else {
                const error = data.error || data[fieldName]?.error || 'Upload failed';
                statusDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${error}</div>`;
                fileInput.parentElement.classList.add('error');
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Upload failed: ${error.message}</div>`;
            fileInput.parentElement.classList.add('error');
        });
    }
    
    function setupDataSourceToggle() {
        const csvRadio = document.getElementById('csv-source');
        const adoRadio = document.getElementById('ado-source');
        const csvSection = document.getElementById('csv-section');
        const adoSection = document.getElementById('ado-section');
        
        csvRadio.addEventListener('change', function() {
            if (this.checked) {
                csvSection.style.display = 'block';
                adoSection.style.display = 'none';
            }
        });
        
        adoRadio.addEventListener('change', function() {
            if (this.checked) {
                csvSection.style.display = 'none';
                adoSection.style.display = 'block';
            }
        });
        
        // ADO button handlers
        document.getElementById('test-ado-btn').addEventListener('click', testADOConnection);
        document.getElementById('fetch-ado-btn').addEventListener('click', fetchADOData);
    }
    
    function setupCriteriaInputToggles() {
        // Annual Review toggles
        const annualUploadRadio = document.getElementById('annual-upload-method');
        const annualManualRadio = document.getElementById('annual-manual-method');
        const annualUploadSection = document.getElementById('annual-upload-section');
        const annualManualSection = document.getElementById('annual-manual-section');
        
        annualUploadRadio.addEventListener('change', function() {
            if (this.checked) {
                annualUploadSection.style.display = 'block';
                annualManualSection.style.display = 'none';
            }
        });
        
        annualManualRadio.addEventListener('change', function() {
            if (this.checked) {
                annualUploadSection.style.display = 'none';
                annualManualSection.style.display = 'block';
            }
        });
        
        // Competency toggles
        const competencyUploadRadio = document.getElementById('competency-upload-method');
        const competencyManualRadio = document.getElementById('competency-manual-method');
        const competencyUploadSection = document.getElementById('competency-upload-section');
        const competencyManualSection = document.getElementById('competency-manual-section');
        
        competencyUploadRadio.addEventListener('change', function() {
            if (this.checked) {
                competencyUploadSection.style.display = 'block';
                competencyManualSection.style.display = 'none';
            }
        });
        
        competencyManualRadio.addEventListener('change', function() {
            if (this.checked) {
                competencyUploadSection.style.display = 'none';
                competencyManualSection.style.display = 'block';
            }
        });
    }
    
    function setupManualCriteriaHandlers() {
        // Annual criteria handlers
        document.getElementById('add-annual-criteria-btn').addEventListener('click', addAnnualCriteria);
        document.getElementById('save-annual-btn').addEventListener('click', () => saveCriteriaFromForm('annual'));
        
        // Competency criteria handlers
        document.getElementById('add-competency-btn').addEventListener('click', addCompetencyCriteria);
        document.getElementById('save-competency-btn').addEventListener('click', () => saveCriteriaFromForm('competency'));
        
        // Initialize empty criteria storage
        window.annualCriteriaList = [];
        window.competencyCriteriaList = [];
    }
    
    function addAnnualCriteria() {
        const name = document.getElementById('annual-section-name').value.trim();
        const description = document.getElementById('annual-section-description').value.trim();
        const weight = document.getElementById('annual-section-weight').value;
        
        // Validation
        if (!name) {
            showValidationError('annual-section-name', 'Section name is required');
            return;
        }
        
        if (!description) {
            showValidationError('annual-section-description', 'Description is required');
            return;
        }
        
        // Check for duplicates
        if (window.annualCriteriaList.find(item => item.name.toLowerCase() === name.toLowerCase())) {
            showValidationError('annual-section-name', 'Section name already exists');
            return;
        }
        
        // Clear any validation errors
        clearValidationErrors(['annual-section-name', 'annual-section-description']);
        
        // Add to list
        const criteria = {
            name: name,
            description: description,
            weight: weight ? parseInt(weight) : null
        };
        
        window.annualCriteriaList.push(criteria);
        
        // Clear form
        document.getElementById('annual-section-name').value = '';
        document.getElementById('annual-section-description').value = '';
        document.getElementById('annual-section-weight').value = '';
        
        // Update display
        updateAnnualCriteriaDisplay();
        
        showAlert(`Added "${name}" to annual criteria`, 'success');
    }
    
    function addCompetencyCriteria() {
        const name = document.getElementById('competency-name').value.trim();
        const description = document.getElementById('competency-description').value.trim();
        
        const levels = {};
        for (let i = 1; i <= 5; i++) {
            const levelValue = document.getElementById(`competency-level-${i}`).value.trim();
            if (!levelValue) {
                showValidationError(`competency-level-${i}`, `Level ${i} definition is required`);
                return;
            }
            levels[i.toString()] = levelValue;
        }
        
        // Validation
        if (!name) {
            showValidationError('competency-name', 'Competency name is required');
            return;
        }
        
        if (!description) {
            showValidationError('competency-description', 'Description is required');
            return;
        }
        
        // Check for duplicates
        if (window.competencyCriteriaList.find(item => item.name.toLowerCase() === name.toLowerCase())) {
            showValidationError('competency-name', 'Competency name already exists');
            return;
        }
        
        // Clear any validation errors
        clearValidationErrors(['competency-name', 'competency-description', 
                               'competency-level-1', 'competency-level-2', 'competency-level-3', 
                               'competency-level-4', 'competency-level-5']);
        
        // Add to list
        const competency = {
            name: name,
            description: description,
            levels: levels
        };
        
        window.competencyCriteriaList.push(competency);
        
        // Clear form
        document.getElementById('competency-name').value = '';
        document.getElementById('competency-description').value = '';
        for (let i = 1; i <= 5; i++) {
            document.getElementById(`competency-level-${i}`).value = '';
        }
        
        // Update display
        updateCompetencyCriteriaDisplay();
        
        showAlert(`Added "${name}" competency`, 'success');
    }
    
    function showValidationError(fieldId, message) {
        const field = document.getElementById(fieldId);
        field.classList.add('is-invalid');
        
        // Remove existing error message
        const existingError = field.parentElement.querySelector('.invalid-feedback');
        if (existingError) {
            existingError.remove();
        }
        
        // Add new error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        field.parentElement.appendChild(errorDiv);
    }
    
    function clearValidationErrors(fieldIds) {
        fieldIds.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.classList.remove('is-invalid');
            const errorDiv = field.parentElement.querySelector('.invalid-feedback');
            if (errorDiv) {
                errorDiv.remove();
            }
        });
    }
    
    function updateAnnualCriteriaDisplay() {
        const displayDiv = document.getElementById('annual-criteria-display');
        
        if (window.annualCriteriaList.length === 0) {
            displayDiv.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle"></i> No criteria entered yet. Add some above to get started.</div>';
            return;
        }
        
        displayDiv.innerHTML = window.annualCriteriaList.map((criteria, index) => `
            <div class="criteria-item">
                <div class="criteria-content">
                    <h6>${criteria.name}</h6>
                    <div class="description">${criteria.description}</div>
                    ${criteria.weight ? `<div class="weight">Weight: ${criteria.weight}%</div>` : ''}
                </div>
                <div class="criteria-actions">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editAnnualCriteria(${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteAnnualCriteria(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function updateCompetencyCriteriaDisplay() {
        const displayDiv = document.getElementById('competency-criteria-display');
        
        if (window.competencyCriteriaList.length === 0) {
            displayDiv.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle"></i> No competencies entered yet. Add some above to get started.</div>';
            return;
        }
        
        displayDiv.innerHTML = window.competencyCriteriaList.map((competency, index) => `
            <div class="criteria-item">
                <div class="criteria-content">
                    <h6>${competency.name}</h6>
                    <div class="description">${competency.description}</div>
                    <div class="levels">
                        ${Object.entries(competency.levels).map(([level, desc]) => 
                            `<span class="level-badge">${level}: ${desc}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="criteria-actions">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editCompetencyCriteria(${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCompetencyCriteria(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function deleteAnnualCriteria(index) {
        if (confirm(`Delete "${window.annualCriteriaList[index].name}" from annual criteria?`)) {
            window.annualCriteriaList.splice(index, 1);
            updateAnnualCriteriaDisplay();
            showAlert('Annual criteria deleted', 'info');
        }
    }
    
    function deleteCompetencyCriteria(index) {
        if (confirm(`Delete "${window.competencyCriteriaList[index].name}" competency?`)) {
            window.competencyCriteriaList.splice(index, 1);
            updateCompetencyCriteriaDisplay();
            showAlert('Competency deleted', 'info');
        }
    }
    
    function editAnnualCriteria(index) {
        const criteria = window.annualCriteriaList[index];
        document.getElementById('annual-section-name').value = criteria.name;
        document.getElementById('annual-section-description').value = criteria.description;
        document.getElementById('annual-section-weight').value = criteria.weight || '';
        
        // Delete the original and let user re-add it
        deleteAnnualCriteria(index);
    }
    
    function editCompetencyCriteria(index) {
        const competency = window.competencyCriteriaList[index];
        document.getElementById('competency-name').value = competency.name;
        document.getElementById('competency-description').value = competency.description;
        
        Object.entries(competency.levels).forEach(([level, desc]) => {
            document.getElementById(`competency-level-${level}`).value = desc;
        });
        
        // Delete the original and let user re-add it
        deleteCompetencyCriteria(index);
    }
    
    function saveCriteriaFromForm(type) {
        const statusId = type === 'annual' ? 'annual-manual-status' : 'competency-manual-status';
        const statusDiv = document.getElementById(statusId);
        const criteriaList = type === 'annual' ? window.annualCriteriaList : window.competencyCriteriaList;
        
        if (criteriaList.length === 0) {
            statusDiv.innerHTML = '<div class="text-warning"><i class="fas fa-exclamation-triangle"></i> No criteria entered. Please add some criteria first.</div>';
            return;
        }
        
        try {
            // Convert form data to JSON structure
            const criteriaData = {};
            
            if (type === 'annual') {
                criteriaList.forEach(criteria => {
                    criteriaData[criteria.name] = {
                        description: criteria.description
                    };
                    if (criteria.weight) {
                        criteriaData[criteria.name].weight = criteria.weight;
                    }
                });
            } else {
                criteriaList.forEach(competency => {
                    criteriaData[competency.name] = {
                        description: competency.description,
                        levels: competency.levels
                    };
                });
            }
            
            // Create a FormData object to send to the existing API
            const formData = new FormData();
            const fieldName = type === 'annual' ? 'annual_criteria' : 'competency_criteria';
            
            // Create a blob with the JSON data and add it as a file
            const jsonBlob = new Blob([JSON.stringify(criteriaData, null, 2)], { type: 'application/json' });
            const fileName = `${type}_criteria_form_${new Date().toISOString().slice(0, 19).replace(/[:]/g, '-')}.json`;
            
            formData.append(fieldName, jsonBlob, fileName);
            
            statusDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Saving criteria...</div>';
            
            fetch('/api/upload-criteria', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const result = data[fieldName];
                if (result && result.success) {
                    statusDiv.innerHTML = `<div class="text-success"><i class="fas fa-check"></i> Criteria saved successfully (${criteriaList.length} items)</div>`;
                    
                    // Store file path for later use (similar to file upload)
                    if (type === 'annual') {
                        window.annualCriteriaFile = result.path;
                    } else {
                        window.competencyCriteriaFile = result.path;
                    }
                    
                    showAlert(`${type === 'annual' ? 'Annual' : 'Competency'} criteria saved successfully!`, 'success');
                } else {
                    const error = result?.error || data.error || 'Save failed';
                    statusDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${error}</div>`;
                }
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Save failed: ${error.message}</div>`;
            });
            
        } catch (error) {
            statusDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
        }
    }
    
    function setupLLMProviderChange() {
        const providerSelect = document.getElementById('llm-provider');
        const modelSelect = document.getElementById('llm-model'); // Hidden select (for backward compatibility)
        const modelInput = document.getElementById('llm-model-input');
        const clearModelBtn = document.getElementById('clear-model-btn');
        
        // Initialize previously used models storage
        let previouslyUsedModels = JSON.parse(localStorage.getItem('previouslyUsedModels') || '[]');
        
        providerSelect.addEventListener('change', function() {
            const provider = this.value;
            modelSelect.innerHTML = '<option value="">Select model...</option>';
            modelInput.value = ''; // Clear the input when provider changes
            
            if (provider !== 'none' && modelsByProvider[provider]) {
                modelsByProvider[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
            
            // Update the dropdown menu
            updateModelDropdown(provider);
            
            // Check for stored key when provider changes
            checkStoredKey(provider);
        });
        
        // Clear model button handler
        clearModelBtn.addEventListener('click', function() {
            modelInput.value = '';
            modelSelect.value = '';
        });
        
        // Setup dropdown button handler
        const dropdownBtn = document.getElementById('model-dropdown-btn');
        const dropdownMenu = document.getElementById('model-dropdown-menu');
        
        // Toggle dropdown on button click
        dropdownBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isOpen = dropdownMenu.classList.contains('show');
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // Toggle this dropdown
            if (!isOpen) {
                dropdownMenu.classList.add('show');
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });
        
        // Model input change handler - sync with hidden select
        modelInput.addEventListener('input', function() {
            modelSelect.value = this.value;
            
            // Save to previously used models when user types something substantial
            if (this.value.trim() && this.value.length > 3 && !previouslyUsedModels.includes(this.value)) {
                previouslyUsedModels.unshift(this.value);
                // Keep only last 10 previously used models
                previouslyUsedModels = previouslyUsedModels.slice(0, 10);
                localStorage.setItem('previouslyUsedModels', JSON.stringify(previouslyUsedModels));
                
                // Update dropdown with new previously used models
                const provider = providerSelect.value;
                updateModelDropdown(provider);
            }
        });
        
        // Setup key storage button handlers
        document.getElementById('store-key-btn').addEventListener('click', storeApiKey);
        document.getElementById('delete-key-btn').addEventListener('click', deleteStoredKey);
        
        // Update key display when API key field changes
        document.getElementById('llm-api-key').addEventListener('input', updateKeyButtons);
        
        // Initialize default provider models and check for stored key
        const initialProvider = providerSelect.value;
        if (initialProvider !== 'none') {
            // Populate models for initially selected provider
            if (modelsByProvider[initialProvider]) {
                modelsByProvider[initialProvider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
                // Select a default model if available
                if (modelsByProvider[initialProvider].length > 0) {
                    const defaultModel = modelsByProvider[initialProvider][0];
                    modelSelect.value = defaultModel;
                    modelInput.value = defaultModel;
                }
            }
            updateModelDropdown(initialProvider);
            checkStoredKey(initialProvider);
        } else {
            updateModelDropdown('none');
        }
    }
    
    function updateModelDropdown(provider) {
        const dropdown = document.getElementById('model-dropdown-menu');
        const previouslyUsedModels = JSON.parse(localStorage.getItem('previouslyUsedModels') || '[]');
        
        // Clear existing content
        dropdown.innerHTML = '';
        
        // Add common models section if provider is selected
        if (provider !== 'none' && modelsByProvider[provider]) {
            const commonHeader = document.createElement('li');
            commonHeader.innerHTML = '<h6 class="dropdown-header">Common Models</h6>';
            dropdown.appendChild(commonHeader);
            
            modelsByProvider[provider].forEach(model => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = 'dropdown-item';
                a.href = '#';
                a.textContent = model;
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectModel(model);
                });
                li.appendChild(a);
                dropdown.appendChild(li);
            });
            
            // Add divider if we have previously used models
            if (previouslyUsedModels.length > 0) {
                const divider = document.createElement('li');
                divider.innerHTML = '<hr class="dropdown-divider">';
                dropdown.appendChild(divider);
            }
        }
        
        // Add previously used models section
        if (previouslyUsedModels.length > 0) {
            const prevHeader = document.createElement('li');
            prevHeader.innerHTML = '<h6 class="dropdown-header">Previously Used</h6>';
            dropdown.appendChild(prevHeader);
            
            previouslyUsedModels.forEach(model => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = 'dropdown-item';
                a.href = '#';
                a.textContent = model;
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectModel(model);
                });
                li.appendChild(a);
                dropdown.appendChild(li);
            });
        }
        
        // Show empty state if no models available
        if (dropdown.children.length === 0) {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.className = 'dropdown-item text-muted';
            span.textContent = 'No models available';
            li.appendChild(span);
            dropdown.appendChild(li);
        }
    }
    
    function selectModel(model) {
        const modelInput = document.getElementById('llm-model-input');
        const modelSelect = document.getElementById('llm-model');
        const dropdownMenu = document.getElementById('model-dropdown-menu');
        
        modelInput.value = model;
        modelSelect.value = model;
        
        // Close the dropdown
        dropdownMenu.classList.remove('show');
    }
    
    function testADOConnection() {
        const org = document.getElementById('ado-org').value;
        const project = document.getElementById('ado-project').value;
        const token = document.getElementById('ado-token').value;
        const status = document.getElementById('ado-status');
        
        if (!org || !project || !token) {
            status.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Please fill in all ADO fields</div>';
            return;
        }
        
        status.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Testing connection...</div>';
        
        fetch('/api/test-ado-connection', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ado_org: org,
                ado_project: project,
                ado_token: token
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                status.innerHTML = `<div class="text-success"><i class="fas fa-check"></i> Connected successfully (User ID: ${data.user_id})</div>`;
            } else {
                status.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Connection failed: ${data.error}</div>`;
            }
        })
        .catch(error => {
            status.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Connection failed: ${error.message}</div>`;
        });
    }
    
    function fetchADOData() {
        const org = document.getElementById('ado-org').value;
        const project = document.getElementById('ado-project').value;
        const token = document.getElementById('ado-token').value;
        const workItemType = document.getElementById('work-item-type').value;
        const monthsBack = parseInt(document.getElementById('months-back').value);
        const status = document.getElementById('ado-status');
        
        if (!org || !project || !token) {
            status.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Please fill in all ADO fields</div>';
            return;
        }
        
        status.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Fetching data...</div>';
        
        fetch('/api/fetch-ado-data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ado_org: org,
                ado_project: project,
                ado_token: token,
                work_item_type: workItemType,
                months_back: monthsBack
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                status.innerHTML = `<div class="text-success"><i class="fas fa-check"></i> Fetched ${data.work_items_count} work items</div>`;
                // Store the CSV file path for later use
                window.adoDataFile = data.csv_file;
            } else {
                status.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Fetch failed: ${data.error}</div>`;
            }
        })
        .catch(error => {
            status.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Fetch failed: ${error.message}</div>`;
        });
    }
    
    function setupGenerateButton() {
        document.getElementById('generate-btn').addEventListener('click', generateReview);
    }
    
    function generateReview() {
        // Gather all form data
        const reviewType = document.getElementById('review-type').value;
        const reviewYear = document.getElementById('review-year').value;
        const dataSource = document.querySelector('input[name="data-source"]:checked').value;
        const outputFormat = document.querySelector('input[name="output-format"]:checked').value;
        const llmProvider = document.getElementById('llm-provider').value;
        const llmModel = document.getElementById('llm-model-input').value || document.getElementById('llm-model').value;
        const apiKey = document.getElementById('llm-api-key').value;
        
        // Prepare request data
        const requestData = {
            review_type: reviewType,
            year: parseInt(reviewYear),
            data_source: dataSource,
            output_format: outputFormat,
            llm_provider: llmProvider,
            llm_model: llmModel,
            api_key: apiKey
        };
        
        // Add data file based on data source
        if (dataSource === 'csv' && window.csvDataFile) {
            requestData.csv_file = window.csvDataFile;
        } else if (dataSource === 'ado' && window.adoDataFile) {
            requestData.csv_file = window.adoDataFile;
        }
        
        // Show progress
        showProgress(true);
        document.getElementById('generate-btn').disabled = true;
        
        // Make request
        fetch('/api/run-analysis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            showProgress(false);
            document.getElementById('generate-btn').disabled = false;
            
            if (data.success) {
                const resultContent = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> Analysis Complete!</h5>
                        <p>Your ${reviewType} review for ${reviewYear} has been generated successfully.</p>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="/api/download-result/${data.result_file}" class="btn btn-primary btn-lg">
                            <i class="fas fa-download"></i> Download ${outputFormat.toUpperCase()} Report
                        </a>
                    </div>
                `;
                showResult(resultContent, true);
                showAlert('Performance review generated successfully!', 'success');
            } else {
                showAlert(`Analysis failed: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            showProgress(false);
            document.getElementById('generate-btn').disabled = false;
            showAlert(`Analysis failed: ${error.message}`, 'danger');
        });
    }
    
    function checkStoredKey(provider) {
        const statusDiv = document.getElementById('stored-key-status');
        const storeBtn = document.getElementById('store-key-btn');
        const deleteBtn = document.getElementById('delete-key-btn');
        
        if (provider === 'none' || !provider) {
            statusDiv.textContent = '';
            storeBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            return;
        }
        
        fetch(`/api/get-stored-key/${provider}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_key) {
                statusDiv.innerHTML = `<i class="fas fa-key text-success"></i> Stored key: ${data.key_preview}`;
                if (data.model) {
                    statusDiv.innerHTML += ` (Model: ${data.model})`;
                }
                storeBtn.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
                
                // Clear the API key field since we have a stored one
                document.getElementById('llm-api-key').value = '';
                
                // Populate the model field if we have a stored model
                if (data.model) {
                    document.getElementById('llm-model-input').value = data.model;
                    document.getElementById('llm-model').value = data.model;
                }
            } else {
                statusDiv.textContent = 'No stored key found';
                updateKeyButtons();
            }
        })
        .catch(error => {
            console.error('Error checking stored key:', error);
            statusDiv.textContent = 'Error checking stored key';
            updateKeyButtons();
        });
    }
    
    function updateKeyButtons() {
        const apiKeyField = document.getElementById('llm-api-key');
        const provider = document.getElementById('llm-provider').value;
        const storeBtn = document.getElementById('store-key-btn');
        const deleteBtn = document.getElementById('delete-key-btn');
        
        if (provider === 'none' || !provider) {
            storeBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            return;
        }
        
        if (apiKeyField.value.trim()) {
            storeBtn.style.display = 'inline-block';
        } else {
            storeBtn.style.display = 'none';
        }
    }
    
    function storeApiKey() {
        const provider = document.getElementById('llm-provider').value;
        const apiKey = document.getElementById('llm-api-key').value.trim();
        const model = document.getElementById('llm-model-input').value || document.getElementById('llm-model').value;
        const statusDiv = document.getElementById('stored-key-status');
        
        if (!provider || provider === 'none') {
            showAlert('Please select a provider first', 'warning');
            return;
        }
        
        if (!apiKey) {
            showAlert('Please enter an API key to store', 'warning');
            return;
        }
        
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Storing key...';
        
        fetch('/api/store-api-key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                provider: provider,
                api_key: apiKey,
                model: model
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                checkStoredKey(provider); // Refresh the display
            } else {
                showAlert(`Failed to store key: ${data.error}`, 'danger');
                statusDiv.textContent = 'Error storing key';
            }
        })
        .catch(error => {
            showAlert(`Failed to store key: ${error.message}`, 'danger');
            statusDiv.textContent = 'Error storing key';
        });
    }
    
    function deleteStoredKey() {
        const provider = document.getElementById('llm-provider').value;
        const statusDiv = document.getElementById('stored-key-status');
        
        if (!provider || provider === 'none') {
            return;
        }
        
        if (!confirm(`Delete stored API key for ${provider}?`)) {
            return;
        }
        
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting key...';
        
        fetch(`/api/delete-api-key/${provider}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                checkStoredKey(provider); // Refresh the display
            } else {
                showAlert(`Failed to delete key: ${data.error}`, 'danger');
                statusDiv.textContent = 'Error deleting key';
            }
        })
        .catch(error => {
            showAlert(`Failed to delete key: ${error.message}`, 'danger');
            statusDiv.textContent = 'Error deleting key';
        });
    }
    
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.parentElement.querySelector('.api-key-toggle i');
        
        if (input.type === 'password') {
            input.type = 'text';
            button.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            button.className = 'fas fa-eye';
        }
    }
</script>
{% endblock %}
