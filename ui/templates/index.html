{% extends "base.html" %}

{% block title %}Performance Review Tracker - Dashboard{% endblock %}

{% block content %}
<div class="main-header">
    <h1><i class="fas fa-chart-line"></i> Performance Review Tracker</h1>
    <p>Generate professional performance reviews with AI-powered analysis</p>
</div>

<!-- Workflow Selection Screen -->
<div id="workflow-selection" class="workflow-selection">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="workflow-intro text-center mb-5">
                <h2>Choose Your Review Type</h2>
                <p class="lead">Select the type of performance review you'd like to generate</p>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="workflow-card" data-workflow="competency">
                        <div class="workflow-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <h3>Competency Assessment</h3>
                        <p>Evaluate performance across 13 professional competency areas with detailed skill-level analysis and development recommendations.</p>
                        <ul class="workflow-features">
                            <li>13 professional competency areas</li>
                            <li>5-point skill level assessment</li>
                            <li>Evidence-based ratings</li>
                            <li>Development gap analysis</li>
                        </ul>
                        <button class="btn btn-primary btn-lg w-100" onclick="selectWorkflow('competency')">
                            <i class="fas fa-arrow-right"></i> Start Competency Assessment
                        </button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="workflow-card" data-workflow="annual">
                        <div class="workflow-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <h3>Annual Review</h3>
                        <p>Generate comprehensive annual performance reviews with customizable criteria, goal achievement analysis, and career progression insights.</p>
                        <ul class="workflow-features">
                            <li>Customizable review criteria</li>
                            <li>Goal achievement tracking</li>
                            <li>Career progression analysis</li>
                            <li>Professional summary</li>
                        </ul>
                        <button class="btn btn-success btn-lg w-100" onclick="selectWorkflow('annual')">
                            <i class="fas fa-arrow-right"></i> Start Annual Review
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Workflow Screen -->
<div id="main-workflow" class="main-workflow" style="display: none;">
    <!-- Progress Header -->
    <div class="progress-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 id="workflow-title"></h2>
                <div class="workflow-badge">
                    <span id="workflow-type-badge" class="badge"></span>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-secondary" onclick="resetWorkflow()">
                    <i class="fas fa-arrow-left"></i> Change Review Type
                </button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-container mt-3">
            <div class="progress-steps">
                <div class="progress-step" data-step="criteria">
                    <div class="step-circle">1</div>
                    <span class="step-label">Criteria</span>
                </div>
                <div class="progress-step" data-step="data">
                    <div class="step-circle">2</div>
                    <span class="step-label">Data</span>
                </div>
                <div class="progress-step" data-step="ai">
                    <div class="step-circle">3</div>
                    <span class="step-label">AI Setup</span>
                </div>
                <div class="progress-step" data-step="generate">
                    <div class="step-circle">4</div>
                    <span class="step-label">Generate</span>
                </div>
                <div class="progress-step" data-step="results">
                    <div class="step-circle">5</div>
                    <span class="step-label">Results</span>
                </div>
            </div>
            <div class="progress-line"></div>
        </div>
    </div>

    <!-- Step 1: Criteria Configuration -->
    <div class="workflow-step" id="step-criteria">
        <div class="row">
            <div class="col-lg-8">
                <div class="step-card">
                    <div class="step-header">
                        <h4 id="criteria-title"></h4>
                        <p id="criteria-description"></p>
                    </div>
                    
                    <div class="criteria-tabs">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#upload-tab">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#manual-tab">
                                    <i class="fas fa-edit"></i> Enter Manually
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content">
                            <!-- Upload Tab -->
                            <div class="tab-pane fade show active" id="upload-tab">
                                <div class="upload-area" id="criteria-upload-area">
                                    <input type="file" id="criteria-file" accept=".json" style="display: none;">
                                    <i class="fas fa-upload fa-3x mb-3"></i>
                                    <h5>Upload Criteria File</h5>
                                    <p>Click or drag to upload your criteria JSON file</p>
                                    <small class="text-muted">JSON format required</small>
                                </div>
                                <div id="criteria-upload-status" class="mt-3"></div>
                            </div>
                            
                            <!-- Manual Tab -->
                            <div class="tab-pane fade" id="manual-tab">
                                <div id="manual-criteria-form">
                                    <!-- Dynamic form content based on workflow type -->
                                </div>
                                <div id="criteria-manual-status" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="sidebar-card">
                    <h5><i class="fas fa-info-circle"></i> About This Step</h5>
                    <div id="criteria-help"></div>
                    
                    <div class="step-actions mt-4">
                        <button class="btn btn-primary" onclick="nextStep()" id="criteria-next-btn" disabled>
                            Next: Data Source <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Data Source -->
    <div class="workflow-step" id="step-data" style="display: none;">
        <div class="row">
            <div class="col-lg-8">
                <div class="step-card">
                    <div class="step-header">
                        <h4>Choose Your Data Source</h4>
                        <p>Select how you want to provide your accomplishment data</p>
                    </div>
                    
                    <div class="data-source-options">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="data-source-card" data-source="csv">
                                    <input type="radio" name="data-source" id="csv-source" value="csv" checked>
                                    <label for="csv-source" class="data-source-label">
                                        <div class="data-source-icon">
                                            <i class="fas fa-file-csv"></i>
                                        </div>
                                        <h5>CSV Upload</h5>
                                        <p>Upload a CSV file with your accomplishments</p>
                                        <small class="text-muted">Requires Date and Title columns</small>
                                    </label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- CSV Section -->
                    <div id="csv-config" class="data-config-section">
                        <div class="upload-area" id="csv-upload-area">
                            <input type="file" id="accomplishments-csv-file" accept=".csv" style="display: none;">
                            <i class="fas fa-file-csv fa-3x mb-3"></i>
                            <h5>Upload Accomplishments</h5>
                            <p>Click or drag to upload your accomplishments CSV</p>
                            <small class="text-muted">Minimum required: Date and Title columns</small>
                        </div>
                        <div id="csv-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="sidebar-card">
                    <h5><i class="fas fa-info-circle"></i> Data Requirements</h5>
                    <div class="data-help">
                        <h6>CSV Format:</h6>
                        <ul>
                            <li><strong>Date:</strong> When the accomplishment occurred</li>
                            <li><strong>Title:</strong> Brief description</li>
                            <li><strong>Description:</strong> Detailed explanation (optional)</li>
                            <li><strong>Impact:</strong> Business impact level (optional)</li>
                        </ul>
                    </div>
                    
                    <div class="step-actions mt-4">
                        <button class="btn btn-outline-secondary me-2" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()" id="data-next-btn" disabled>
                            Next: AI Analysis <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: AI Analysis -->
    <div class="workflow-step" id="step-ai" style="display: none;">
        <div class="row">
            <div class="col-lg-8">
                <div class="step-card">
                    <div class="step-header">
                        <h4>AI Analysis Configuration</h4>
                        <p>Configure AI-powered analysis or use automated processing</p>
                    </div>
                    
                    <div class="ai-options">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="llm-provider" class="form-label">AI Provider</label>
                                <select id="llm-provider" class="form-select">
                                    <option value="none">No AI (Automated Only)</option>
                                    {% for provider in llm_providers %}
                                    <option value="{{ provider.id }}" {% if provider.recommended %}selected{% endif %}>{{ provider.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="llm-model" class="form-label">Model</label>
                                <div class="model-input-group">
                                    <input type="text" id="llm-model-input" class="form-control" placeholder="Select or enter model">
                                    <div class="model-controls">
                                        <button type="button" id="clear-model-btn" class="btn btn-sm btn-outline-secondary" title="Clear">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <div class="dropdown">
                                            <button type="button" id="model-dropdown-btn" class="btn btn-sm btn-outline-primary dropdown-toggle" title="Browse models" data-bs-toggle="dropdown">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" id="model-dropdown-menu">
                                                <!-- Available Models -->
                                                <li><h6 class="dropdown-header"><i class="fas fa-brain"></i> Available Models</h6></li>
                                                <li><a class="dropdown-item" href="#" data-model="google/gemini-2.5-pro"><strong>Gemini 2.5 Pro</strong> <span class="badge bg-primary">Latest</span></a></li>
                                                <li><a class="dropdown-item" href="#" data-model="coding/claude-4-sonnet"><strong>Claude 4 Sonnet</strong> <span class="badge bg-success">Coding</span></a></li>
                                                <li><a class="dropdown-item" href="#" data-model="deepinfra/deepseek-ai/DeepSeek-R1"><strong>DeepSeek R1</strong> <span class="badge bg-info">Reasoning</span></a></li>
                                                <li><a class="dropdown-item" href="#" data-model="openai/gpt-5"><strong>GPT-5</strong> <span class="badge bg-warning">Preview</span></a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-muted" href="#" style="cursor: default;"><i class="fas fa-info-circle"></i> You can also type a custom model name above</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <select id="llm-model" class="form-select" style="display: none;"></select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="llm-api-key" class="form-label">API Key</label>
                                <div class="api-key-input">
                                    <input type="password" id="llm-api-key" class="form-control" placeholder="Enter API key (optional)">
                                    <button type="button" class="api-key-toggle" onclick="togglePasswordVisibility('llm-api-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="api-key-status mt-2">
                                    <div id="stored-key-status" class="text-muted small"></div>
                                    <div class="btn-group-sm mt-1">
                                        <button type="button" id="store-key-btn" class="btn btn-sm btn-outline-success" style="display: none;">
                                            <i class="fas fa-save"></i> Store Key
                                        </button>
                                        <button type="button" id="delete-key-btn" class="btn btn-sm btn-outline-danger" style="display: none;">
                                            <i class="fas fa-trash"></i> Delete Key
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="sidebar-card">
                    <h5><i class="fas fa-info-circle"></i> AI Analysis</h5>
                    <div class="ai-help">
                        <h6>Automated Processing:</h6>
                        <ul>
                            <li>Fast keyword-based analysis</li>
                            <li>Statistical impact scoring</li>
                            <li>Consistent results</li>
                        </ul>
                        
                        <h6 class="mt-3">AI-Enhanced Analysis:</h6>
                        <ul>
                            <li>Nuanced accomplishment interpretation</li>
                            <li>Strategic insights and recommendations</li>
                            <li>Professional narrative generation</li>
                        </ul>
                    </div>
                    
                    <div class="step-actions mt-4">
                        <button class="btn btn-outline-secondary me-2" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()" id="ai-next-btn">
                            Next: Generate <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Generate -->
    <div class="workflow-step" id="step-generate" style="display: none;">
        <div class="row">
            <div class="col-lg-8">
                <div class="step-card">
                    <div class="step-header">
                        <h4>Generate Your Review</h4>
                        <p>Configure output format and generate your performance review</p>
                    </div>
                    
                    <div class="generate-options">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Review Year</label>
                                <select id="review-year" class="form-select">
                                    {% for year in year_options %}
                                    <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Output Format</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="output-format" id="markdown-format" value="markdown" checked>
                                    <label class="btn btn-outline-primary" for="markdown-format">
                                        <i class="fab fa-markdown"></i> Markdown
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="output-format" id="docx-format" value="docx">
                                    <label class="btn btn-outline-primary" for="docx-format">
                                        <i class="fas fa-file-word"></i> Word
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="generation-summary">
                            <h5>Review Summary</h5>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-label">Review Type:</span>
                                    <span class="summary-value" id="summary-type"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Data Source:</span>
                                    <span class="summary-value" id="summary-data"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">AI Analysis:</span>
                                    <span class="summary-value" id="summary-ai"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Year:</span>
                                    <span class="summary-value" id="summary-year"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="generate-action text-center mt-4">
                            <button type="button" id="generate-btn" class="btn btn-success btn-lg px-5">
                                <i class="fas fa-magic"></i> Generate Performance Review
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="sidebar-card">
                    <h5><i class="fas fa-check-circle"></i> Ready to Generate</h5>
                    <div class="generate-help">
                        <p>Your performance review will include:</p>
                        <ul id="generate-features"></ul>
                    </div>
                    
                    <div class="step-actions mt-4">
                        <button class="btn btn-outline-secondary" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 5: Results -->
    <div class="workflow-step" id="step-results" style="display: none;">
        <div class="row">
            <div class="col-12">
                <div class="step-card">
                    <div class="step-header">
                        <h4><i class="fas fa-check-circle text-success"></i> Performance Review Generated</h4>
                        <p>Your performance review has been successfully generated and is ready for download</p>
                    </div>
                    
                    <!-- Process Statistics -->
                    <div class="process-stats mb-4">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="stat-card" data-stat="time">
                                    <div class="stat-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6>Processing Time</h6>
                                        <span id="final-processing-time" class="stat-value">--:--</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card" data-stat="size">
                                    <div class="stat-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6>File Size</h6>
                                        <span id="final-file-size" class="stat-value">-- KB</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card" data-stat="ai">
                                    <div class="stat-icon">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6>AI Provider</h6>
                                        <span id="final-ai-provider" class="stat-value">--</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card" data-stat="generated">
                                    <div class="stat-icon">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6>Generated</h6>
                                        <span id="final-generated-time" class="stat-value">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Content Preview -->
                    <div class="report-preview-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-file-alt"></i> Report Content</h5>
                            <div class="report-preview-actions">
                                <button type="button" id="expand-preview-btn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-expand"></i> Expand
                                </button>
                                <button type="button" id="copy-content-btn" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button type="button" id="download-file-btn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <div id="report-preview-content" class="report-preview-content">
                            <!-- Report content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="results-actions mt-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-success btn-lg w-100" onclick="generateAnotherReview()">
                                    <i class="fas fa-plus"></i> Generate Another Review
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary btn-lg w-100" onclick="resetWorkflow()">
                                    <i class="fas fa-home"></i> Start Over
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator">
    <div class="section-card">
        <div class="section-header">
            <div class="section-number"><i class="fas fa-cog fa-spin"></i></div>
            <h3>Generating Your Review</h3>
        </div>
        <div class="progress-content">
            <div class="progress-stage mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 id="current-stage" class="mb-0">Initializing...</h5>
                    <div class="progress-timer">
                        <span class="badge bg-info">
                            <i class="fas fa-clock"></i> <span id="elapsed-time">00:00</span>
                        </span>
                    </div>
                </div>
                <p id="stage-message" class="text-muted mb-1">Starting analysis...</p>
                <p id="stage-details" class="text-muted small mb-0" style="opacity: 0.8;"></p>
            </div>
            <div class="progress mb-3" style="height: 12px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <span id="progress-percentage" class="small fw-bold" style="line-height: 12px;">0%</span>
                </div>
            </div>
            <div class="progress-stages small text-muted">
                <div class="row g-2">
                    <div class="col-3"><span id="stage-init" class="badge bg-secondary">Initializing</span></div>
                    <div class="col-3"><span id="stage-config" class="badge bg-secondary">Configuration</span></div>
                    <div class="col-3"><span id="stage-processing" class="badge bg-secondary">Processing</span></div>
                    <div class="col-3"><span id="stage-finalizing" class="badge bg-secondary">Finalizing</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Display -->
<div class="result-display">
    <div class="section-card">
        <div class="section-header">
            <div class="section-number"><i class="fas fa-check-circle text-success"></i></div>
            <h3>Performance Review Generated</h3>
            <div class="ms-auto">
                <button type="button" class="btn btn-outline-primary" onclick="generateAnotherReview()">
                    <i class="fas fa-plus"></i> Generate Another Review
                </button>
            </div>
        </div>
        <div id="result-content">
            <!-- Summary Section -->
            <div id="result-summary" class="result-summary mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h6><i class="fas fa-info-circle"></i> Review Details</h6>
                            <div id="review-details">
                                <div class="detail-item">
                                    <span class="detail-label">Type:</span>
                                    <span id="summary-review-type" class="detail-value">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Year:</span>
                                    <span id="summary-review-year" class="detail-value">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Data Source:</span>
                                    <span id="summary-data-source" class="detail-value">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Format:</span>
                                    <span id="summary-format" class="detail-value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h6><i class="fas fa-robot"></i> AI Analysis</h6>
                            <div id="ai-details">
                                <div class="detail-item">
                                    <span class="detail-label">Provider:</span>
                                    <span id="summary-llm-provider" class="detail-value">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Model:</span>
                                    <span id="summary-llm-model" class="detail-value">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">File Size:</span>
                                    <span id="summary-file-size" class="detail-value">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Generated:</span>
                                    <span id="summary-generated-at" class="detail-value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Content Section -->
            <div id="report-content-section" class="report-content-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-file-alt"></i> Report Content</h5>
                    <div class="report-actions">
                        <button type="button" id="copy-report-btn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                        <button type="button" id="download-report-btn" class="btn btn-primary btn-sm">
                            <i class="fas fa-download"></i> Download Report
                        </button>
                    </div>
                </div>
                <div id="report-content" class="report-content">
                    <!-- Report content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables
    const modelsByProvider = {{ common_models | tojson }};
    let currentWorkflow = null;
    let currentStep = 'criteria';
    let stepData = {};
    
    // Global variables for progress tracking
    let currentJobId = null;
    let progressInterval = null;
    let timerInterval = null;
    let analysisStartTime = null;

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        initializeWorkflow();
    });

    function initializeWorkflow() {
        // Show workflow selection screen initially
        document.getElementById('workflow-selection').style.display = 'block';
        document.getElementById('main-workflow').style.display = 'none';
    }

    // Workflow Selection Functions
    function selectWorkflow(workflowType) {
        currentWorkflow = workflowType;
        showMainWorkflow();
        setupWorkflowContent();
        setupEventHandlers();
        setActiveStep('criteria');
    }

    function resetWorkflow() {
        // Reset global state
        currentWorkflow = null;
        currentStep = 'criteria';
        stepData = {};
        
        // Show workflow selection
        document.getElementById('workflow-selection').style.display = 'block';
        document.getElementById('main-workflow').style.display = 'none';
        
        // Clear any stored data
        window.csvDataFile = null;
        window.criteriaFile = null;
    }

    function showMainWorkflow() {
        document.getElementById('workflow-selection').style.display = 'none';
        document.getElementById('main-workflow').style.display = 'block';
        
        // Update workflow title and badge
        const title = currentWorkflow === 'competency' ? 'Competency Assessment' : 'Annual Review';
        const badgeClass = currentWorkflow === 'competency' ? 'bg-primary' : 'bg-success';
        
        document.getElementById('workflow-title').textContent = title;
        document.getElementById('workflow-type-badge').textContent = title;
        document.getElementById('workflow-type-badge').className = `badge ${badgeClass}`;
    }

    function setupWorkflowContent() {
        // Setup criteria step content based on workflow type
        const criteriaTitle = document.getElementById('criteria-title');
        const criteriaDescription = document.getElementById('criteria-description');
        const criteriaHelp = document.getElementById('criteria-help');
        
        if (currentWorkflow === 'competency') {
            criteriaTitle.textContent = 'Competency Criteria Configuration';
            criteriaDescription.textContent = 'Define the competency areas and skill levels for your assessment';
            criteriaHelp.innerHTML = `
                <p>Competency assessments evaluate performance across professional skill areas.</p>
                <h6>What you'll need:</h6>
                <ul>
                    <li>13 competency areas (Programming, Architecture, etc.)</li>
                    <li>5-point rating scale definitions</li>
                    <li>Evidence-based evaluation criteria</li>
                </ul>
                <p class="text-muted small">You can upload a JSON file or enter criteria manually.</p>
            `;
        } else {
            criteriaTitle.textContent = 'Annual Review Criteria Configuration';
            criteriaDescription.textContent = 'Define the evaluation criteria and goals for your annual review';
            criteriaHelp.innerHTML = `
                <p>Annual reviews assess overall performance and goal achievement.</p>
                <h6>What you'll need:</h6>
                <ul>
                    <li>Performance evaluation sections</li>
                    <li>Goal achievement criteria</li>
                    <li>Optional: Section weightings</li>
                </ul>
                <p class="text-muted small">You can upload a JSON file or enter criteria manually.</p>
            `;
        }
        
        // Setup manual criteria form
        setupManualCriteriaForm();
    }

    function setupManualCriteriaForm() {
        const formContainer = document.getElementById('manual-criteria-form');
        
        if (currentWorkflow === 'competency') {
            formContainer.innerHTML = `
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-plus-circle"></i> Add Competency Area</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="competency-name" class="form-label">Competency Name</label>
                            <input type="text" id="competency-name" class="form-control" 
                                   placeholder="e.g., Programming, Problem Management">
                        </div>
                        <div class="col-md-6">
                            <label for="competency-description" class="form-label">Description</label>
                            <input type="text" id="competency-description" class="form-control" 
                                   placeholder="e.g., Software development and coding skills">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Level Definitions (1-5 scale)</label>
                        <div class="row g-2">
                            <div class="col">
                                <label class="form-label small">Level 1 (Learning)</label>
                                <input type="text" id="competency-level-1" class="form-control form-control-sm" 
                                       placeholder="Beginning to apply">
                            </div>
                            <div class="col">
                                <label class="form-label small">Level 2 (Developing)</label>
                                <input type="text" id="competency-level-2" class="form-control form-control-sm" 
                                       placeholder="Building proficiency">
                            </div>
                            <div class="col">
                                <label class="form-label small">Level 3 (Practicing)</label>
                                <input type="text" id="competency-level-3" class="form-control form-control-sm" 
                                       placeholder="Consistent competency">
                            </div>
                            <div class="col">
                                <label class="form-label small">Level 4 (Mastering)</label>
                                <input type="text" id="competency-level-4" class="form-control form-control-sm" 
                                       placeholder="Advanced proficiency">
                            </div>
                            <div class="col">
                                <label class="form-label small">Level 5 (Leading)</label>
                                <input type="text" id="competency-level-5" class="form-control form-control-sm" 
                                       placeholder="Expert level">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" id="add-competency-btn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Competency
                        </button>
                    </div>
                </div>
                
                <div class="criteria-display mb-3">
                    <h6><i class="fas fa-list"></i> Added Competencies</h6>
                    <div id="competency-criteria-display" class="border rounded p-3 bg-light">
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle"></i> No competencies added yet.
                        </div>
                    </div>
                </div>
                
                <div class="text-end">
                    <button type="button" id="save-competency-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save All Competencies
                    </button>
                </div>
            `;
        } else {
            formContainer.innerHTML = `
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-plus-circle"></i> Add Review Section</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="annual-section-name" class="form-label">Section Name</label>
                            <input type="text" id="annual-section-name" class="form-control" 
                                   placeholder="e.g., Leadership, Innovation">
                        </div>
                        <div class="col-md-6">
                            <label for="annual-section-description" class="form-label">Description</label>
                            <input type="text" id="annual-section-description" class="form-control" 
                                   placeholder="e.g., Demonstrates leadership capabilities">
                        </div>
                        <div class="col-md-2">
                            <label for="annual-section-weight" class="form-label">Weight (%)</label>
                            <input type="number" id="annual-section-weight" class="form-control" 
                                   placeholder="20" min="1" max="100">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" id="add-annual-criteria-btn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Section
                        </button>
                    </div>
                </div>
                
                <div class="criteria-display mb-3">
                    <h6><i class="fas fa-list"></i> Added Sections</h6>
                    <div id="annual-criteria-display" class="border rounded p-3 bg-light">
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle"></i> No sections added yet.
                        </div>
                    </div>
                </div>
                
                <div class="text-end">
                    <button type="button" id="save-annual-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save All Sections
                    </button>
                </div>
            `;
        }
        
        // Initialize storage arrays
        window.annualCriteriaList = [];
        window.competencyCriteriaList = [];
    }

    function setupEventHandlers() {
        // Criteria upload handler
        setupCriteriaUpload();
        
        // Manual criteria handlers
        setupManualCriteriaHandlers();
        
        // Data source handlers
        setupDataSourceHandlers();
        
        // LLM configuration handlers
        setupLLMHandlers();
        
        // Generate button handler
        setupGenerateHandler();
    }

    function setupCriteriaUpload() {
        const uploadArea = document.getElementById('criteria-upload-area');
        const fileInput = document.getElementById('criteria-file');
        const statusDiv = document.getElementById('criteria-upload-status');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleCriteriaUpload(fileInput, statusDiv);
            }
        });
        
        fileInput.addEventListener('change', () => {
            handleCriteriaUpload(fileInput, statusDiv);
        });
    }

    function handleCriteriaUpload(fileInput, statusDiv) {
        const file = fileInput.files[0];
        if (!file) return;
        
        const formData = new FormData();
        const fieldName = currentWorkflow === 'competency' ? 'competency_criteria' : 'annual_criteria';
        formData.append(fieldName, file);
        
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Uploading...</div>';
        
        fetch('/api/upload-criteria', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            const result = data[fieldName];
            if (result && result.success) {
                statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check"></i> Uploaded successfully (${result.sections || 0} items)</div>`;
                window.criteriaFile = result.path;
                enableNextButton('criteria');
            } else {
                const error = result?.error || data.error || 'Upload failed';
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${error}</div>`;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Upload failed: ${error.message}</div>`;
        });
    }

    function setupManualCriteriaHandlers() {
        // Add event listeners based on workflow type
        if (currentWorkflow === 'competency') {
            document.getElementById('add-competency-btn').addEventListener('click', addCompetencyCriteria);
            document.getElementById('save-competency-btn').addEventListener('click', () => saveCriteriaFromForm('competency'));
        } else {
            document.getElementById('add-annual-criteria-btn').addEventListener('click', addAnnualCriteria);
            document.getElementById('save-annual-btn').addEventListener('click', () => saveCriteriaFromForm('annual'));
        }
    }

    function setupDataSourceHandlers() {
        // CSV upload - only data source now
        setupFileUpload('csv-upload-area', 'accomplishments-csv-file', 'csv-status', '/api/upload-accomplishments', 'accomplishments_csv');
    }

    function setupFileUpload(areaId, fileInputId, statusId, endpoint, fieldName) {
        const area = document.getElementById(areaId);
        const fileInput = document.getElementById(fileInputId);
        const status = document.getElementById(statusId);
        
        area.addEventListener('click', () => fileInput.click());
        
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });
        
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileUpload(fileInput, status, endpoint, fieldName);
            }
        });
        
        fileInput.addEventListener('change', () => {
            handleFileUpload(fileInput, status, endpoint, fieldName);
        });
    }

    function handleFileUpload(fileInput, statusDiv, endpoint, fieldName) {
        const file = fileInput.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append(fieldName, file);
        
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Uploading...</div>';
        
        fetch(endpoint, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || data[fieldName]?.success) {
                const result = data[fieldName] || data;
                statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check"></i> Uploaded successfully (${result.rows || result.sections || 0} items)</div>`;
                
                if (fieldName === 'accomplishments_csv' && result.path) {
                    window.csvDataFile = result.path;
                    enableNextButton('data');
                }
            } else {
                const error = data.error || data[fieldName]?.error || 'Upload failed';
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${error}</div>`;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Upload failed: ${error.message}</div>`;
        });
    }

    function setupLLMHandlers() {
        setupLLMProviderChange();
        setupModelDropdown();
        setupModelClear();
    }

    function setupGenerateHandler() {
        document.getElementById('generate-btn').addEventListener('click', generateReview);
    }

    // Step Navigation Functions
    function nextStep() {
        const stepOrder = ['criteria', 'data', 'ai', 'generate', 'results'];
        const currentIndex = stepOrder.indexOf(currentStep);
        if (currentIndex < stepOrder.length - 1) {
            const nextStepName = stepOrder[currentIndex + 1];
            setActiveStep(nextStepName);
        }
    }

    function prevStep() {
        const stepOrder = ['criteria', 'data', 'ai', 'generate', 'results'];
        const currentIndex = stepOrder.indexOf(currentStep);
        if (currentIndex > 0) {
            const prevStepName = stepOrder[currentIndex - 1];
            setActiveStep(prevStepName);
        }
    }

    function setActiveStep(stepName) {
        // Hide all steps
        document.querySelectorAll('.workflow-step').forEach(step => {
            step.style.display = 'none';
        });
        
        // Show current step
        document.getElementById(`step-${stepName}`).style.display = 'block';
        
        // Update progress indicators
        updateProgressIndicators(stepName);
        
        // Update current step
        currentStep = stepName;
        
        // Update generate summary if on generate step
        if (stepName === 'generate') {
            updateGenerateSummary();
        }
    }

    function updateProgressIndicators(activeStep) {
        const steps = ['criteria', 'data', 'ai', 'generate', 'results'];
        const activeIndex = steps.indexOf(activeStep);
        
        steps.forEach((step, index) => {
            const progressStep = document.querySelector(`[data-step="${step}"]`);
            progressStep.classList.remove('active', 'completed');
            
            if (index < activeIndex) {
                progressStep.classList.add('completed');
            } else if (index === activeIndex) {
                progressStep.classList.add('active');
            }
        });
    }

    function enableNextButton(stepName) {
        const button = document.getElementById(`${stepName}-next-btn`);
        if (button) {
            button.disabled = false;
        }
    }

    function updateGenerateSummary() {
        // Update summary values
        document.getElementById('summary-type').textContent = currentWorkflow === 'competency' ? 'Competency Assessment' : 'Annual Review';
        
        document.getElementById('summary-data').textContent = 'CSV Upload';
        
        const aiProvider = document.getElementById('llm-provider')?.value || 'none';
        document.getElementById('summary-ai').textContent = aiProvider === 'none' ? 'Automated Only' : aiProvider;
        
        const year = document.getElementById('review-year')?.value || new Date().getFullYear();
        document.getElementById('summary-year').textContent = year;
        
        // Update features list
        const featuresList = document.getElementById('generate-features');
        if (currentWorkflow === 'competency') {
            featuresList.innerHTML = `
                <li>13 professional competency areas</li>
                <li>5-point skill level assessment</li>
                <li>Evidence-based ratings</li>
                <li>Development recommendations</li>
                <li>Professional formatting</li>
            `;
        } else {
            featuresList.innerHTML = `
                <li>Customizable review criteria</li>
                <li>Goal achievement analysis</li>
                <li>Performance summary</li>
                <li>Career progression insights</li>
                <li>Professional formatting</li>
            `;
        }
    }

    // Manual Criteria Functions (simplified versions of the original)
    function addCompetencyCriteria() {
        const name = document.getElementById('competency-name').value.trim();
        const description = document.getElementById('competency-description').value.trim();
        
        if (!name || !description) {
            showAlert('Please fill in competency name and description', 'warning');
            return;
        }
        
        const levels = {};
        for (let i = 1; i <= 5; i++) {
            const levelValue = document.getElementById(`competency-level-${i}`).value.trim();
            if (!levelValue) {
                showAlert(`Please fill in Level ${i} definition`, 'warning');
                return;
            }
            levels[i.toString()] = levelValue;
        }
        
        const competency = { name, description, levels };
        window.competencyCriteriaList.push(competency);
        
        // Clear form
        document.getElementById('competency-name').value = '';
        document.getElementById('competency-description').value = '';
        for (let i = 1; i <= 5; i++) {
            document.getElementById(`competency-level-${i}`).value = '';
        }
        
        updateCompetencyCriteriaDisplay();
        showAlert(`Added "${name}" competency`, 'success');
    }

    function addAnnualCriteria() {
        const name = document.getElementById('annual-section-name').value.trim();
        const description = document.getElementById('annual-section-description').value.trim();
        const weight = document.getElementById('annual-section-weight').value;
        
        if (!name || !description) {
            showAlert('Please fill in section name and description', 'warning');
            return;
        }
        
        const criteria = { name, description, weight: weight ? parseInt(weight) : null };
        window.annualCriteriaList.push(criteria);
        
        // Clear form
        document.getElementById('annual-section-name').value = '';
        document.getElementById('annual-section-description').value = '';
        document.getElementById('annual-section-weight').value = '';
        
        updateAnnualCriteriaDisplay();
        showAlert(`Added "${name}" section`, 'success');
    }

    function updateCompetencyCriteriaDisplay() {
        const displayDiv = document.getElementById('competency-criteria-display');
        
        if (window.competencyCriteriaList.length === 0) {
            displayDiv.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle"></i> No competencies added yet.</div>';
            return;
        }
        
        displayDiv.innerHTML = window.competencyCriteriaList.map((competency, index) => `
            <div class="border rounded p-2 mb-2 bg-white">
                <h6 class="mb-1">${competency.name}</h6>
                <p class="text-muted small mb-1">${competency.description}</p>
                <div class="d-flex gap-1 flex-wrap">
                    ${Object.entries(competency.levels).map(([level, desc]) => 
                        `<span class="badge bg-secondary">${level}: ${desc}</span>`
                    ).join('')}
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="deleteCompetencyCriteria(${index})">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        `).join('');
    }

    function updateAnnualCriteriaDisplay() {
        const displayDiv = document.getElementById('annual-criteria-display');
        
        if (window.annualCriteriaList.length === 0) {
            displayDiv.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle"></i> No sections added yet.</div>';
            return;
        }
        
        displayDiv.innerHTML = window.annualCriteriaList.map((criteria, index) => `
            <div class="border rounded p-2 mb-2 bg-white d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${criteria.name}</h6>
                    <p class="text-muted small mb-0">${criteria.description}</p>
                    ${criteria.weight ? `<span class="badge bg-primary">Weight: ${criteria.weight}%</span>` : ''}
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAnnualCriteria(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }

    function deleteCompetencyCriteria(index) {
        if (confirm(`Delete "${window.competencyCriteriaList[index].name}" competency?`)) {
            window.competencyCriteriaList.splice(index, 1);
            updateCompetencyCriteriaDisplay();
            showAlert('Competency deleted', 'info');
        }
    }

    function deleteAnnualCriteria(index) {
        if (confirm(`Delete "${window.annualCriteriaList[index].name}" section?`)) {
            window.annualCriteriaList.splice(index, 1);
            updateAnnualCriteriaDisplay();
            showAlert('Section deleted', 'info');
        }
    }

    function saveCriteriaFromForm(type) {
        const criteriaList = type === 'annual' ? window.annualCriteriaList : window.competencyCriteriaList;
        const statusDiv = document.getElementById('criteria-manual-status');
        
        if (criteriaList.length === 0) {
            statusDiv.innerHTML = '<div class="alert alert-warning">No criteria entered. Please add some criteria first.</div>';
            return;
        }
        
        const criteriaData = {};
        
        if (type === 'annual') {
            criteriaList.forEach(criteria => {
                criteriaData[criteria.name] = {
                    description: criteria.description
                };
                if (criteria.weight) {
                    criteriaData[criteria.name].weight = criteria.weight;
                }
            });
        } else {
            criteriaList.forEach(competency => {
                criteriaData[competency.name] = {
                    description: competency.description,
                    levels: competency.levels
                };
            });
        }
        
        const formData = new FormData();
        const fieldName = type === 'annual' ? 'annual_criteria' : 'competency_criteria';
        const jsonBlob = new Blob([JSON.stringify(criteriaData, null, 2)], { type: 'application/json' });
        const fileName = `${type}_criteria_form_${new Date().toISOString().slice(0, 19).replace(/[:]/g, '-')}.json`;
        
        formData.append(fieldName, jsonBlob, fileName);
        
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Saving criteria...</div>';
        
        fetch('/api/upload-criteria', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            const result = data[fieldName];
            if (result && result.success) {
                statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check"></i> Criteria saved successfully (${criteriaList.length} items)</div>`;
                window.criteriaFile = result.path;
                enableNextButton('criteria');
                showAlert(`${type === 'annual' ? 'Annual' : 'Competency'} criteria saved successfully!`, 'success');
            } else {
                const error = result?.error || data.error || 'Save failed';
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${error}</div>`;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Save failed: ${error.message}</div>`;
        });
    }

    // Enhanced LLM Provider Setup with Model Dropdown
    function setupLLMProviderChange() {
        const providerSelect = document.getElementById('llm-provider');
        const modelInput = document.getElementById('llm-model-input');
        
        providerSelect.addEventListener('change', function() {
            const provider = this.value;
            
            // Only clear model if switching to/from 'none'
            if (provider === 'none') {
                modelInput.value = '';
            } else if (modelInput.value === '' && modelsByProvider[provider]) {
                // Set default model only if input is empty
                const defaultModel = modelsByProvider[provider][0];
                modelInput.value = defaultModel;
            }
            
            checkStoredKey(provider);
        });
        
        // Setup API key storage handlers
        document.getElementById('store-key-btn').addEventListener('click', storeApiKey);
        document.getElementById('delete-key-btn').addEventListener('click', deleteStoredKey);
        document.getElementById('llm-api-key').addEventListener('input', updateKeyButtons);
        
        // Initialize
        const initialProvider = providerSelect.value;
        if (initialProvider !== 'none' && modelsByProvider[initialProvider] && modelInput.value === '') {
            modelInput.value = modelsByProvider[initialProvider][0];
        }
        checkStoredKey(initialProvider);
    }

    // Setup Model Dropdown Selection
    function setupModelDropdown() {
        const modelDropdownItems = document.querySelectorAll('#model-dropdown-menu .dropdown-item');
        const modelInput = document.getElementById('llm-model-input');
        
        modelDropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedModel = this.getAttribute('data-model');
                
                // Skip if this is the info item (no data-model attribute)
                if (!selectedModel) {
                    return;
                }
                
                modelInput.value = selectedModel;
                
                // Close dropdown
                const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('model-dropdown-btn'));
                if (dropdown) {
                    dropdown.hide();
                }
                
                // Show visual feedback
                this.classList.add('active');
                setTimeout(() => this.classList.remove('active'), 200);
            });
        });
        
        // Highlight selected model in dropdown when opened
        document.getElementById('model-dropdown-btn').addEventListener('show.bs.dropdown', function() {
            const currentModel = modelInput.value;
            modelDropdownItems.forEach(item => {
                const itemModel = item.getAttribute('data-model');
                if (itemModel === currentModel) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        });
    }

    // Setup Model Clear Button
    function setupModelClear() {
        const clearBtn = document.getElementById('clear-model-btn');
        const modelInput = document.getElementById('llm-model-input');
        
        clearBtn.addEventListener('click', function() {
            modelInput.value = '';
            modelInput.focus();
            
            // Visual feedback
            this.classList.add('btn-outline-danger');
            setTimeout(() => this.classList.remove('btn-outline-danger'), 200);
        });
        
        // Show/hide clear button based on input content
        function updateClearButtonVisibility() {
            if (modelInput.value.trim()) {
                clearBtn.style.display = 'inline-block';
            } else {
                clearBtn.style.display = 'none';
            }
        }
        
        modelInput.addEventListener('input', updateClearButtonVisibility);
        modelInput.addEventListener('change', updateClearButtonVisibility);
        
        // Initialize visibility
        updateClearButtonVisibility();
    }


    // Generate Review Function with Live Progress
    function generateReview() {
        const reviewType = currentWorkflow;
        const reviewYear = document.getElementById('review-year').value;
        const outputFormat = document.querySelector('input[name="output-format"]:checked').value;
        const llmProvider = document.getElementById('llm-provider').value;
        const llmModel = document.getElementById('llm-model-input').value;
        const apiKey = document.getElementById('llm-api-key').value;
        
        const requestData = {
            review_type: reviewType,
            year: parseInt(reviewYear),
            data_source: 'csv',
            output_format: outputFormat,
            llm_provider: llmProvider,
            llm_model: llmModel,
            api_key: apiKey
        };
        
        // Add CSV data file
        if (window.csvDataFile) {
            requestData.csv_file = window.csvDataFile;
        }
        
        // Show progress and start tracking
        showProgress(true);
        document.getElementById('generate-btn').disabled = true;
        
        // Start timer immediately when analysis begins
        analysisStartTime = new Date();
        startTimer();
        
        // Start the analysis
        fetch('/api/run-analysis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentJobId = data.job_id;
                
                // Start progress polling
                progressInterval = setInterval(() => {
                    updateProgressDisplay(currentJobId);
                }, 1000);
                
                // Wait for completion and then display results
                waitForCompletion(currentJobId, data, progressInterval);
            } else {
                showProgress(false);
                stopTimer();
                document.getElementById('generate-btn').disabled = false;
                resetAnalysisState();
                showAlert(`Analysis failed: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            showProgress(false);
            stopTimer();
            document.getElementById('generate-btn').disabled = false;
            resetAnalysisState();
            showAlert(`Analysis failed: ${error.message}`, 'danger');
        });
    }
    
    // Update Progress Display
    function updateProgressDisplay(jobId) {
        fetch(`/api/get-progress/${jobId}`)
        .then(response => response.json())
        .then(progress => {
            // Timer is already started when analysis begins
            // No need to start it again based on server response
            
            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${progress.percentage}%`;
            progressBar.setAttribute('aria-valuenow', progress.percentage);
            
            // Update progress percentage text
            const progressPercentage = document.getElementById('progress-percentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${progress.percentage}%`;
            }
            
            // Update stage information
            const currentStage = document.getElementById('current-stage');
            if (currentStage) {
                currentStage.textContent = formatStageName(progress.stage);
            }
            
            const stageMessage = document.getElementById('stage-message');
            if (stageMessage) {
                stageMessage.textContent = progress.message || 'Processing...';
            }
            
            // Update stage details if available
            const stageDetails = document.getElementById('stage-details');
            if (stageDetails) {
                if (progress.details) {
                    stageDetails.textContent = progress.details;
                    stageDetails.style.display = 'block';
                } else {
                    stageDetails.style.display = 'none';
                }
            }
            
            // Update stage badges
            updateStageBadges(progress.stage);
            
            // Change progress bar color based on stage
            updateProgressBarColor(progress.stage, progress.percentage);
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
        });
    }
    
    // Start Timer
    function startTimer() {
        // Clear any existing timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        timerInterval = setInterval(() => {
            if (analysisStartTime) {
                const now = new Date();
                const elapsed = Math.floor((now - analysisStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const elapsedTimeElement = document.getElementById('elapsed-time');
                if (elapsedTimeElement) {
                    elapsedTimeElement.textContent = timeString;
                }
            }
        }, 1000);
    }
    
    // Stop Timer
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    
    // Update Progress Bar Color
    function updateProgressBarColor(stage, percentage) {
        const progressBar = document.getElementById('progress-bar');
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
        
        if (stage === 'completed') {
            progressBar.classList.add('bg-success');
        } else if (stage === 'error') {
            progressBar.classList.add('bg-danger');
        } else if (percentage >= 80) {
            progressBar.classList.add('bg-warning');
        } else {
            progressBar.classList.add('bg-primary');
        }
    }
    
    // Format Stage Name
    function formatStageName(stage) {
        const stageNames = {
            'initializing': 'Initializing Analysis',
            'configuration': 'Configuring Settings',
            'preparation': 'Preparing Data',
            'processing': 'Processing Data',
            'executing': 'Running Analysis',
            'finalizing': 'Generating Report',
            'completed': 'Analysis Complete',
            'error': 'Error Occurred'
        };
        return stageNames[stage] || stage;
    }
    
    // Update Stage Badges
    function updateStageBadges(currentStage) {
        const stageOrder = ['initializing', 'configuration', 'processing', 'finalizing'];
        const stageMap = {
            'initializing': 'stage-init',
            'configuration': 'stage-config', 
            'preparation': 'stage-config',
            'processing': 'stage-processing',
            'executing': 'stage-processing',
            'finalizing': 'stage-finalizing',
            'completed': 'stage-finalizing'
        };
        
        // Reset all badges
        stageOrder.forEach(stage => {
            const badge = document.getElementById(`stage-${stage === 'initializing' ? 'init' : stage === 'configuration' ? 'config' : stage}`);
            if (badge) {
                badge.className = 'badge bg-secondary';
            }
        });
        
        // Update current stage
        const currentBadgeId = stageMap[currentStage];
        if (currentBadgeId) {
            const badge = document.getElementById(currentBadgeId);
            if (badge) {
                badge.className = 'badge bg-primary';
            }
        }
        
        // Mark completed stages
        const currentIndex = stageOrder.indexOf(currentStage);
        if (currentIndex > 0) {
            for (let i = 0; i < currentIndex; i++) {
                const stage = stageOrder[i];
                const badge = document.getElementById(`stage-${stage === 'initializing' ? 'init' : stage === 'configuration' ? 'config' : stage}`);
                if (badge) {
                    badge.className = 'badge bg-success';
                }
            }
        }
    }
    
    // Wait for Completion
    function waitForCompletion(jobId, responseData, progressInterval) {
        const checkCompletion = () => {
            fetch(`/api/get-progress/${jobId}`)
            .then(response => response.json())
            .then(progress => {
                if (progress.stage === 'completed' || progress.percentage >= 100) {
                    // Stop progress polling and timer
                    clearInterval(progressInterval);
                    stopTimer();
                    
                    // Ensure progress shows 100% completion briefly
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) progressBar.style.width = '100%';
                    
                    const progressMessage = document.getElementById('progress-message');
                    if (progressMessage) progressMessage.textContent = 'Analysis completed successfully!';
                    
                    const progressDetails = document.getElementById('progress-details');
                    if (progressDetails) progressDetails.textContent = 'Report generated and ready for download';
                    
                    // Hide progress and show results after showing completion
                    setTimeout(() => {
                        showProgress(false);
                        displayResults(responseData);
                        document.getElementById('generate-btn').disabled = false;
                        resetAnalysisState();
                    }, 2000);
                } else if (progress.stage === 'error') {
                    clearInterval(progressInterval);
                    stopTimer();
                    showProgress(false);
                    document.getElementById('generate-btn').disabled = false;
                    resetAnalysisState();
                    showAlert(`Analysis failed: ${progress.message}`, 'danger');
                } else {
                    // Continue checking
                    setTimeout(checkCompletion, 2000);
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                stopTimer();
                showProgress(false);
                document.getElementById('generate-btn').disabled = false;
                resetAnalysisState();
                showAlert(`Analysis monitoring failed: ${error.message}`, 'danger');
            });
        };
        
        // Start checking for completion
        setTimeout(checkCompletion, 2000);
    }
    
    // Display Results
    function displayResults(data) {
        console.log('displayResults called with data:', data);
        
        if (!data.success) {
            showAlert(`Analysis failed: ${data.error}`, 'danger');
            return;
        }
        
        console.log('Navigating to results step...');
        
        // Navigate to results step first
        setActiveStep('results');
        
        // Wait a moment for the DOM elements to be visible
        setTimeout(() => {
            console.log('Populating results data...');
            populateResultsData(data);
        }, 250);
        
        showAlert('Performance review generated successfully!', 'success');
    }
    
    // Populate Results Data
    function populateResultsData(data) {
        console.log('populateResultsData called with:', data);
        
        const metadata = data.metadata || {};
        
        // Calculate processing time
        const processingTime = analysisStartTime ? 
            Math.floor((new Date() - analysisStartTime) / 1000) : 0;
        const minutes = Math.floor(processingTime / 60);
        const seconds = processingTime % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        console.log('Looking for results elements...');
        
        // Update process statistics with null checks
        const timeElement = document.getElementById('final-processing-time');
        console.log('timeElement:', timeElement);
        if (timeElement) timeElement.textContent = timeString;
        
        const sizeElement = document.getElementById('final-file-size');
        console.log('sizeElement:', sizeElement);
        if (sizeElement) sizeElement.textContent = formatFileSize(metadata.file_size || 0);
        
        const providerElement = document.getElementById('final-ai-provider');
        console.log('providerElement:', providerElement);
        if (providerElement) providerElement.textContent = metadata.llm_provider || 'Automated Only';
        
        const generatedElement = document.getElementById('final-generated-time');
        console.log('generatedElement:', generatedElement);
        if (generatedElement) generatedElement.textContent = formatDateTime(metadata.generated_at);
        
        // Load and display report content
        if (data.result_file) {
            console.log('Loading report content for:', data.result_file);
            loadReportContentForResults(data.result_file);
        }
        
        // Setup download button for results screen
        const downloadBtn = document.getElementById('download-file-btn');
        console.log('downloadBtn:', downloadBtn);
        if (downloadBtn) {
            downloadBtn.onclick = () => {
                window.open(`/api/download-result/${data.result_file}`, '_blank');
            };
        }
        
        // Setup results screen event handlers
        setupResultsScreenHandlers();
        
        console.log('Results data population complete');
    }
    
    // Load Report Content
    function loadReportContent(filename) {
        fetch(`/api/get-result-content/${filename}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('report-content').textContent = data.content;
                setupCopyButton(data.content);
            } else {
                document.getElementById('report-content').textContent = 'Error loading report content.';
            }
        })
        .catch(error => {
            document.getElementById('report-content').textContent = 'Failed to load report content.';
            console.error('Error loading report content:', error);
        });
    }
    
    // Setup Copy Button
    function setupCopyButton(content) {
        const copyBtn = document.getElementById('copy-report-btn');
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(content).then(() => {
                // Show success feedback
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.classList.add('btn-copy-success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('btn-copy-success');
                }, 2000);
                
                showAlert('Report content copied to clipboard!', 'success');
            }).catch(err => {
                showAlert('Failed to copy to clipboard', 'warning');
                console.error('Copy failed:', err);
            });
        };
    }
    
    // Utility Functions
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function formatDateTime(isoString) {
        if (!isoString) return 'Unknown';
        try {
            const date = new Date(isoString);
            return date.toLocaleString();
        } catch (e) {
            return 'Invalid date';
        }
    }

    // Utility Functions (simplified versions)
    function checkStoredKey(provider) {
        const statusDiv = document.getElementById('stored-key-status');
        const storeBtn = document.getElementById('store-key-btn');
        const deleteBtn = document.getElementById('delete-key-btn');
        
        if (provider === 'none' || !provider) {
            statusDiv.textContent = '';
            storeBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            return;
        }
        
        fetch(`/api/get-stored-key/${provider}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_key) {
                statusDiv.innerHTML = `<i class="fas fa-key text-success"></i> Stored key: ${data.key_preview}`;
                storeBtn.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
                document.getElementById('llm-api-key').value = '';
                if (data.model) {
                    document.getElementById('llm-model-input').value = data.model;
                }
            } else {
                statusDiv.textContent = 'No stored key found';
                updateKeyButtons();
            }
        })
        .catch(() => {
            statusDiv.textContent = 'Error checking stored key';
            updateKeyButtons();
        });
    }

    function updateKeyButtons() {
        const apiKeyField = document.getElementById('llm-api-key');
        const provider = document.getElementById('llm-provider').value;
        const storeBtn = document.getElementById('store-key-btn');
        
        if (provider === 'none' || !provider || !apiKeyField.value.trim()) {
            storeBtn.style.display = 'none';
        } else {
            storeBtn.style.display = 'inline-block';
        }
    }

    function storeApiKey() {
        const provider = document.getElementById('llm-provider').value;
        const apiKey = document.getElementById('llm-api-key').value.trim();
        const model = document.getElementById('llm-model-input').value;
        
        if (!provider || provider === 'none' || !apiKey) {
            showAlert('Please select a provider and enter an API key', 'warning');
            return;
        }
        
        fetch('/api/store-api-key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ provider, api_key: apiKey, model })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                checkStoredKey(provider);
            } else {
                showAlert(`Failed to store key: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            showAlert(`Failed to store key: ${error.message}`, 'danger');
        });
    }

    function deleteStoredKey() {
        const provider = document.getElementById('llm-provider').value;
        
        if (!confirm(`Delete stored API key for ${provider}?`)) return;
        
        fetch(`/api/delete-api-key/${provider}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                checkStoredKey(provider);
            } else {
                showAlert(`Failed to delete key: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            showAlert(`Failed to delete key: ${error.message}`, 'danger');
        });
    }

    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.parentElement.querySelector('.api-key-toggle i');
        
        if (input.type === 'password') {
            input.type = 'text';
            button.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            button.className = 'fas fa-eye';
        }
    }
    
    // Reset Analysis State
    function resetAnalysisState() {
        analysisStartTime = null;
        currentJobId = null;
        
        // Reset progress display to initial state
        document.getElementById('elapsed-time').textContent = '00:00';
        document.getElementById('current-stage').textContent = 'Initializing...';
        document.getElementById('stage-message').textContent = 'Starting analysis...';
        document.getElementById('stage-details').textContent = '';
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-percentage').textContent = '0%';
        
        // Reset stage badges
        const badges = ['stage-init', 'stage-config', 'stage-processing', 'stage-finalizing'];
        badges.forEach(badgeId => {
            const badge = document.getElementById(badgeId);
            if (badge) {
                badge.className = 'badge bg-secondary';
            }
        });
        
        // Reset progress bar color
        const progressBar = document.getElementById('progress-bar');
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
    }
    
    // Load Report Content for Results Screen
    function loadReportContentForResults(filename) {
        fetch(`/api/get-result-content/${filename}`)
        .then(response => response.json())
        .then(data => {
            const contentElement = document.getElementById('report-preview-content');
            if (contentElement) {
                if (data.success) {
                    contentElement.textContent = data.content;
                    setupResultsCopyButton(data.content);
                } else {
                    contentElement.textContent = 'Error loading report content.';
                }
            }
        })
        .catch(error => {
            const contentElement = document.getElementById('report-preview-content');
            if (contentElement) {
                contentElement.textContent = 'Failed to load report content.';
            }
            console.error('Error loading report content:', error);
        });
    }
    
    // Setup Results Screen Event Handlers
    function setupResultsScreenHandlers() {
        // Expand/Collapse functionality
        const expandBtn = document.getElementById('expand-preview-btn');
        const previewContent = document.getElementById('report-preview-content');
        
        if (expandBtn && previewContent) {
            expandBtn.onclick = () => {
                if (previewContent.classList.contains('expanded')) {
                    previewContent.classList.remove('expanded');
                    expandBtn.innerHTML = '<i class="fas fa-expand"></i> Expand';
                } else {
                    previewContent.classList.add('expanded');
                    expandBtn.innerHTML = '<i class="fas fa-compress"></i> Collapse';
                }
            };
        }
    }
    
    // Setup Copy Button for Results Screen
    function setupResultsCopyButton(content) {
        const copyBtn = document.getElementById('copy-content-btn');
        if (copyBtn) {
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(content).then(() => {
                    // Show success feedback
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    copyBtn.classList.add('btn-copy-success');
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.remove('btn-copy-success');
                    }, 2000);
                    
                    showAlert('Report content copied to clipboard!', 'success');
                }).catch(err => {
                    showAlert('Failed to copy to clipboard', 'warning');
                    console.error('Copy failed:', err);
                });
            };
        }
    }
    
    function generateAnotherReview() {
        // Go back to the generate step (step 4)
        setActiveStep('generate');
        
        // Re-enable the generate button
        document.getElementById('generate-btn').disabled = false;
        
        // Reset analysis state
        resetAnalysisState();
        
        // Show success message
        showAlert('Ready to generate another performance review!', 'info');
    }
    
    function resetWorkflow() {
        // Go back to step 1 (criteria)
        setActiveStep('criteria');
        
        // Reset all form data
        resetAllFormData();
        
        // Reset analysis state
        resetAnalysisState();
        
        // Clear any stored data
        selectedWorkflow = null;
        currentStep = 'criteria';
        
        // Show info message
        showAlert('Workflow reset. Start with selecting your criteria!', 'info');
    }
    
    function resetAllFormData() {
        // Reset criteria
        document.querySelectorAll('[data-criteria-type]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('manual-criteria-text').value = '';
        
        // Reset data source
        document.querySelectorAll('input[name="data_source"]').forEach(radio => {
            radio.checked = false;
        });
        
        // Reset AI configuration
        document.getElementById('llm-api-key').value = '';
        document.getElementById('llm-model-input').value = '';
        
        // Clear file uploads
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.value = '';
        });
        
        // Reset buttons to disabled state
        document.querySelectorAll('[id$="-next-btn"]').forEach(btn => {
            btn.disabled = true;
        });
    }
</script>
{% endblock %}
